---
title: "TSL2 Hypothesis 3"
author: "A.G. Mitchell"
date: '2022-06-07'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

##### Libraries #####
if (!require("pacman")) install.packages("pacman")
  pacman::p_load(boot, broom.mixed, car, caret, ggeffects, 
                 gghalves, ggpol, ggpubr, groupdata2, lme4, lmerTest, 
                 RColorBrewer, rcompanion,
                 reshape2, Rmisc, ROCR, rsample, tidyverse, wesanderson,
                 bayesplot, brms, cmdstanr, extraDistr, furrr)
```

# Getting data
```{r}
tsl_file <- file.path("data", "anonymised_tsl2_208.csv")
sum_file <- file.path("data", "summary_tsl2_208.csv")

# load all data file
if (file.exists(tsl_file)){
  tsl2 <- read.csv(tsl_file)
  } else {
    print('Data file does not exist, check data is in current directory.')
  }
# load data summary file
if (file.exists(sum_file)){
  sum_dat <- read.csv(sum_file)
  } else {
    print('Data file does not exist, check data is in current directory if not, run tsl2_phs_q1.Rmd first')
  }
```

Functions at the top
# Zscore function
```{r}
calc_z <- function (value) {
  z_score <- (value - mean(value))/sd(value)
}
```

# contrast function
Calculating contrast
TCF - thermal contrast function (developed by FF)
```{r}
# the TCF assumes that maximum possible TSL temperature is 50deg
TCF <- function (Tmax, Tmin) {
  top_temp = 50
  contrast <- (Tmax - Tmin)/top_temp
}
```

# Organise data and calculate contrast for each trial
# First innocuous thermal contrast
```{r}
# extract relevant trials (etc)
df <- tsl2 %>% 
  filter(task == "tsl2" & quality == 'cold',instruction == 'detect') %>% 
  select(c(exp_id,instruction,trial,baseline,threshold,phs,age,gender)) %>% 
  dplyr::rename(subject = exp_id,
         phs_01 = phs) %>% 
  drop_na() #move nas
# any value < 0 should = 0
df$threshold[df$threshold < 0] <- 0
  
# using the thermal contrast function:
  # (tmax - tmin)/max possible temp (50)
df_con <- df
baselineT <- 32 #temperature below which pp can detect change

# then calculate contrast from max temperature
df_con <- df_con %>% 
  mutate(TCF = TCF(baseline, threshold))

```

# try and fit PF to data
```{r}
df_con %>% filter(subject < 21) %>% 
  ggplot(aes(x = TCF, y = phs_01, colour = as_factor(subject))) +
  geom_point() +
  facet_wrap(~subject) +
  theme_classic() +
  theme(legend.position = 'none')

# stan model
stanHmodel1 <- cmdstanr::cmdstan_model('phs-hierarchical_p1.stan') #initiate model

# run
fit = stanHmodel1$sample(data = list(N = nrow(df_con), 
                                    tcf = (df_con$TCF)*100,
                                    phs = df_con$phs_01,
                                    S = length(unique(df_con$subject)),
                                    S_id = df_con$subject),
                        refresh = 200,
                        iter_sampling = 1000,
                        iter_warmup = 1000,
                        parallel_chains = 4,
                        max_treedepth = 12,
                        adapt_delta = 0.95,
                        init = 0)

fit$diagnostic_summary()
fit$summary(c('mus_phs','sigmas_phs'))
mcmc_trace(fit$draws(variables = c('mus_phs','sigmas_phs'))) #hairy caterpillars
```

